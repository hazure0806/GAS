## 領収書メール送付自動化プロジェクト：開発資料

### 1\. 開発フロー

本案件を以下のフェーズに分けて開発を進めます。

| フェーズ            | 項目                   | 主な作業内容                                                                                                                      | 成果物                                               |
| :------------------ | :--------------------- | :-------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------- |
| **1. 開発**         | **環境構築・実装**     | ・Googleドライブのフォルダ構成定義\<br\>・Googleスプレッドシートのテンプレート作成\<br\>・Google Apps Script (GAS) のコーディング | ・スプレッドシート テンプレート\<br\>・GASスクリプト |
|                     | **単体テスト**         | ・開発者による基本的な動作確認\<br\>・エラー処理の動作確認                                                                        | -                                                    |
| **2. テスト**       | **ユーザーテスト**     | ・作成した一式を利用者（Aya様、takeshi-iwata様）へ共有\<br\>・テスト用のデータ（数件分）を用いた実際の操作テストを依頼            | テスト結果フィードバック                             |
|                     | **フィードバック収集** | ・操作感、エラー時の挙動、文言などの確認\<br\>・改善点のヒアリング                                                                | 改善要望リスト                                       |
| **3. 修正・最終化** | **改修作業**           | ・テストで発見された不具合の修正\<br\>・フィードバックに基づく軽微な調整                                                          | 修正済みスクリプト                                   |
| **4. 納品**         | **納品・運用開始**     | ・完成版のスクリプトとスプレッドシートを納品\<br\>・簡易的な操作マニュアルの提供                                                  | ・完成版一式\<br\>・簡易操作マニュアル               |

---

### 2\. 要件定義書

#### 2.1. 案件概要

毎月紙で郵送している領収書を、PDF形式でメールにて送付する作業を、Google Apps Scriptを用いて半自動化し、業務効率を向上させる。

#### 2.2. 背景と目的

- **背景**: 紙での領収書郵送に伴う、通信費、印刷費、封入・投函作業の人的コストが毎月発生している。
- **目的**:
  - 郵送にかかる物理的・人的コストの削減。
  - 担当者の作業負担の軽減と、コア業務への集中。
  - 送付プロセスの迅速化。

#### 2.3. スコープ（対象範囲）

- **対象範囲**:
  - Googleスプレッドシートによる送信先リストの管理。
  - Googleドライブへの領収書PDFのアップロード。
  - スプレッドシート上の操作による、Gmail下書きの一括作成。
  - 作成された下書きの、担当者による目視確認と手動送信。
- **対象範囲外**:
  - 領収書PDF自体の作成機能。
  - 送信メールへの返信対応の自動化。
  - 下書き確認を経ない、完全な自動送信機能。

#### 2.4. 機能要件

| ID    | 要件                       | 詳細                                                                                                                    |
| :---- | :------------------------- | :---------------------------------------------------------------------------------------------------------------------- |
| FE-01 | **リスト管理機能**         | Googleスプレッドシート上で、送信先の契約主名、メールアドレス、患者名、送付するPDFファイル名を管理できること。           |
| FE-02 | **リスト編集機能**         | 送信先の追加・削除・変更が、スプレッドシートの行編集で容易に行えること。（利用者の増減に対応）                          |
| FE-03 | **実行トリガー機能**       | スプレッドシートのカスタムメニューから、担当者が任意のタイミングでメール下書き作成処理を実行できること。                |
| FE-04 | **PDF連携機能**            | スプレッドシートに記載されたPDFファイル名を元に、指定のGoogleドライブフォルダから該当ファイルを検索し、取得できること。 |
| FE-05 | **メールテンプレート機能** | メールの件名と本文のテンプレートをスプレッドシート上で管理し、簡単に編集できること。                                    |
| FE-06 | **メール下書き作成機能**   | 取得した情報（宛先、件名、本文、PDF）を元に、Gmailにメールの下書きを作成できること。                                    |
| FE-07 | **ステータス表示機能**     | 処理が完了した行、またはエラーが発生した行について、スプレッドシート上でステータスが確認できること。                    |

#### 2.5. 非機能要件

| 項目               | 要件                                                                                                                  |
| :----------------- | :-------------------------------------------------------------------------------------------------------------------- |
| **パフォーマンス** | 約60件のリストに対して、現実的な時間（数分以内）で処理が完了すること。                                                |
| **セキュリティ**   | Googleアカウントの認証に基づき動作。個人情報を含むため、最終送信は必ず人間の目視確認を挟むフローとする。              |
| **ユーザビリティ** | PCの基本操作（ファイルアップロード、Excelライクなシート編集）ができる担当者であれば、特別な訓練なしに利用できること。 |
| **メンテナンス性** | 送信先リストやメール文面は、担当者がコードを触ることなくスプレッドシート上で容易に更新できること。                    |

---

### 3\. 設計書

#### 3.1. システム構成

Googleの各サービスを以下のように連携させる。
`[担当者]` → `Googleドライブ (PDFアップロード)`
`[担当者]` → `Googleスプレッドシート (リスト管理・実行指示)` → `Google Apps Script (処理実行)` → `Gmail (下書き作成)`
`[担当者]` → `Gmail (最終確認・送信)`

#### 3.2. データ設計

**1. Googleドライブ フォルダ構成**

- `ルート`
  - `領収書送付システム`（任意名）
    - `領収書PDF` **(←ここにPDFをアップロード)**
    - `管理スプレッドシート.gsheet`

**2. PDFファイル命名規則**

- 規則性を持たせることで、システムが契約者とファイルを紐付けやすくする。
- **形式**: `契約主名_YYYY年M月分.pdf`
- **例**: `山田太郎様_2025年8月分.pdf`

**3. Googleスプレッドシート設計**

- **シート①: `送信リスト`**
  | 列 | 列名 | 内容 | 例 |
  | :--| :--- | :--- | :--- |
  | A | 契約主名 | メールの宛名やファイル検索に使用 | `山田太郎様` |
  | B | メールアドレス | 送信先のメールアドレス | `taro.yamada@example.com` |
  | C | 患者様名 | メールの文面で使用 | `山田花子様` |
  | D | PDFファイル名 | ドライブから探すためのファイル名 | `山田太郎様_2025年8月分.pdf` |
  | E | 処理ステータス | スクリプトが処理結果を書き込む | `作成済み`, `エラー:PDF無し` |

- **シート②: `メール設定`**
  | セル | 項目 | 内容 | 例 |
  | :--| :--- | :--- | :--- |
  | B1 | 件名テンプレート | メールの件名 | `【〇〇医院】領収書のご案内 ({契約主名})` |
  | B2 | 本文テンプレート | メールの本文（改行も反映） | `{契約主名}\n\nお世話になっております。...` |

#### 3.3. 処理フロー設計

1.  担当者がスプレッドシートのカスタムメニュー `[メール作成] > [選択した行の下書きを作成]` をクリック。
2.  GASスクリプトが実行される。
3.  `メール設定`シートから件名・本文のテンプレートを読み込む。
4.  `送信リスト`シートで選択されている行のデータを取得する。
5.  各行に対して、以下のループ処理を行う。
    a. E列（処理ステータス）が「作成済み」ならスキップ。
    b. B列（メールアドレス）とD列（PDFファイル名）が空欄なら、E列にエラーステータスを書き込みスキップ。
    c. D列のファイル名を元に、指定のGoogleドライブフォルダを検索。
    d. PDFファイルが見つからない場合、E列にエラーステータスを書き込みスキップ。
    e. テンプレートとA, C列の情報を組み合わせて、個別の件名・本文を作成。
    f. `GmailApp.createDraft()` を使用し、宛先(B列)、件名、本文、添付PDFを設定した下書きを作成。
    g. 成功した場合、E列に「作成済み」と書き込む。
6.  ループが終了したら、担当者に「処理が完了しました」という旨のダイアログを表示する。

#### 3.4. UI設計

- **操作インターフェース**: Googleスプレッドシート
- **カスタムメニュー**:
  - メニュー名: `メール作成`
  - アイテム名: `選択した行の下書きを作成`
